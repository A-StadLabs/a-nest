<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-field/core-field.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<script src="../../bower_components/color-thief/src/color-thief.js"></script>

<polymer-element name="aos-profiel" attributes="yoyo return">

  <template>
  <link rel="stylesheet" href="aos-profiel.css" />
    <aos-globals id="globals"></aos-globals>

  <template if="{{!$.globals.values.user}}" id="inlog">

    <div vertical layout center center-justified id="canvas">
    <h1>Aanmelden</h1>
    <p>Met A-profiel of AD account.</p>
    <small>{{error}}</small>
    <input name="username" placeholder="Gebruikersnaam" required  value="{{username}}"></input>
    <input name="password" placeholder="Wachtwoord" type="password" required value="{{password}}"></input>
    <h3 hidden?="{{!loading}}">Laden...</h3>
    <button hidden?="{{loading}}" id="buttons" center-justified icon="arrow-forward" on-tap="{{loginSubmit}}">Aanmelden</button><br>
    <small>Gegevens vergeten?</small>
   <core-ajax method="GET" id="loginAjax" handleAs="json" url="/login" response="{{responseUser}}" loading="{{loading}}" on-core-response="{{handleResponseUser}}">
   </core-ajax>
     </div>

   </template>

   <template if="{{$.globals.values.user.data}}">
   <div class="leaderboard">
      <div horizontal layout wrap center start-justified flex>
        <div vertical layout flex>
          <div horizontal layout wrap center><img class="avatar" id="avatar" src="{{$.globals.values.user.data.avatarUrl}}">
        <h1>{{$.globals.values.user.data.firstName}} {{$.globals.values.user.data.lastName}}</h1>
        <!-- <input type="text" on-keyup="{{filter}}" class="searchbox"> --></div>
        </div>
        <div vertical layout wrap center end-justified>
        <button on-tap="{{logout}}" class="logoutbtn">Afmelden</button>
      </div>
    </div>
  </div>
   
    <h1 on-tap="{{colorthief}}">{{$.globals.values.user.data.firstName}}</h1>
    <h2>Gebruikersgegevens</h2>
    <p>{{$.globals.values.user.data.firstName}} {{$.globals.values.user.data.lastName}}</p>
    <p>{{$.globals.values.user.data.username}}</p>
    <p>{{$.globals.values.user.data.email}}</p>
    <p>{{$.globals.values.user.data.phone}}</p>
    <p>{{$.globals.values.user.data.birthDate}}</p>
    <p>{{$.globals.values.user.data.birthPlace}}</p>
    <p>{{$.globals.values.user.data.gender}}</p>
    <p>{{$.globals.values.user.data.maritalStatus}}</p>

    <h2>Email adressen</h2>

    <template repeat="{{ i in $.globals.values.user.data.secondaryEmails}}">
      <p>{{i.email}}</p>
    </template>

    <h2>Rollen:</h2>

    <template repeat="{{ i in $.globals.values.user.data.roles}}">
      <p>{{i}}</p>
    </template>

    <h3>JSON userobject</h3>
    <p>{{$.globals.values.userJSON}}</p>
    <h3>CRS gegevens</h3>
    <p>{{$.globals.values.crsuserJSON}}</p>
    <h3>CRS medewerker gegevens</h3>
    <p>{{$.globals.values.crsmedewerkerJSON}}</p>
   </template>

   <core-ajax method="GET" id="logoutAjax" handleAs="json" url="/logout" response="{{responseLogout}}" on-core-response="{{handleResponseLogout}}">

   <core-ajax method="GET" id="getCRS" handleAs="json" url="/crs-persoon" response="{{responseCRS}}" on-core-response="{{handleResponseCRS}}">

   <core-ajax method="GET" id="getCRSmedewerker" handleAs="json" url="/crs-medewerker" response="{{responseCRSmedewerker}}" on-core-response="{{handleResponseCRSmedewerker}}">

  </template>

  <script>

function colorthief(){
  var colorThief = new ColorThief();
  var avatar = document.getElementById('avatar');
  console.log(avatar);
  var colorT = colorThief.getColor(avatar);
  console.log('colorthief: ', colorT);
}
    Polymer({

      ready: function() {

      	console.log('profiel app loaded.');

        this.addEventListener('keypress', function(e) {
          
          if (e.keyCode == 13) {
              
              //that.enter();
              //ajax.go();
              this.loginSubmit();
          };
          
        });


        },

        logout: function(){
          delete this.$.globals.values;
          delete this.$.globals.values.user;
          delete this.username;
          delete this.password;
          this.$.logoutAjax.go();
          this.fire('show-toast', {bericht: 'Je bent afgemeld.'});
        },

        loginSubmit: function(){
          this.$.loginAjax.params = { "username": this.username, "password": this.password };
          //this.$.loginAjax.params = { "username": "kingflurkel", "password": "mike48" };
          this.$.loginAjax.go();
        },

        handleResponseUser: function(){
          console.log('user resp:', this.responseUser.success);
          if(this.responseUser.success==true){
            this.$.globals.values.user = this.responseUser;
            this.$.globals.values.userJSON = JSON.stringify(this.$.globals.values.user.data);
            console.log('UID: ',this.responseUser.data.uid);
            this.$.getCRS.go();
            if(this.responseUser.data.ADAccount){
              this.$.getCRSmedewerker.go();
            };
            this.fire('show-toast', {bericht: 'Je bent aangemeld.'});
            if(this.return){
              this.fire('router-go', { naarwaar: this.return });
            };
          };
          if(this.responseUser.success==false){
            console.log('inlog error');
            this.error = "Er ging iets fout bij het aanmelden.";
            //delete this.$.globals.values.user;
            delete this.username;
            delete this.password;
          };
        },

        handleResponseCRS: function(){
          console.log('CRS? ', this.responseCRS.success);
          if(this.responseCRS.success){
            console.log('We hebben een eid user!');
            this.$.globals.values.crsuser = this.responseCRS.data;
            this.$.globals.values.crsuserJSON = JSON.stringify(this.responseCRS.data);
          };
        },

        handleResponseCRSmedewerker: function(){
          console.log('CRS? ', this.responseCRSmedewerker.success);
          if(this.responseCRSmedewerker.success){
            console.log('We hebben een eid user!');
            this.$.globals.values.crsmedewerker = this.responseCRSmedewerker.data;
            this.$.globals.values.crsmedewerkerJSON = JSON.stringify(this.responseCRSmedewerker.data);
          };
        },

        colorthief: function(){
          colorthief();
        }

    });

  </script>

</polymer-element>
