<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">

<link rel="import" href="../../elements/aos-globals/aos-globals.html">

<link rel="import" href="ba-elements/ba-user/ba-user.html">
<link rel="import" href="ba-elements/babbel-babbel/babbel-babbel.html">

<polymer-element name="aos-babbles" attributes="">
  <template>
    <link rel="stylesheet" href="aos-babbles.css" />

<div class="leaderboard">
  <img class="stralendeA" src="images/astadlabs.svg">
  <div horizontal layout wrap center start-justified>
    <div horizontal layout wrap center start-justified flex>
      <img class="appicon" src="images/babbelbox.svg">
      <h1>Babbles</h1><input type="text" on-keyup="{{filter}}" class="searchbox">
    </div>
  </div>
</div>

    <aos-globals id="globals"></aos-globals>
    <ba-user bauser="{{bauser}}"></ba-user>

<div id="canvas">
    <core-animated-pages selected="0" id="scenes" transitions="slide-from-right">

    <section>
    <firebase-element id="berichten" location="https://blazing-fire-6426.firebaseio.com/babbles/messages/" orderByChild="parent" equalto="/" data="{{data}}" keys="{{keys}}" on-data-change="{{datachange}}"></firebase-element>

    <template if="{{$.globals.values.user}}">  
      <ba-poster path="/" mode="parent" role="root"></ba-poster>
    </template>
    <template if="{{!$.globals.values.user}}">  
    <div id="roledefinition">
    <small><a href="/#/profiel"><b>Meld je aan</b></a> om een onderwerp te starten of om te reageren.</small></div>
    </template>
    <template repeat="{{k in keys}}">
        <babbel-babbel key="{{k}}" mode="super"></babbel-babbel>
    </template>
    </section>

    <section>
<!--         <babbel-babbel key="{{previousItem}}" mode="previous"></babbel-babbel> -->
        <babbel-babbel key="{{selectedItem}}" mode="parent" id="parent" kids="{{kids}}"></babbel-babbel>
        <template if="{{kidsOk}}">
          <firebase-element id="kids" location="https://blazing-fire-6426.firebaseio.com/babbles/messages/{{selectedItem}}/children/" data="{{cdata}}" keys="{{ckeys}}" on-data-change="{{cdatachange}}" log></firebase-element>
          <template repeat="{{c in ckeys}}">
            <babbel-babbel key="{{c}}" mode="child"></babbel-babbel>  
          </template>
        </template>
    </section>

    </core-animated-pages>

</div>
  </template>

  <script>
    Polymer({

      ready: function() {
      	console.log('\r\r\n\naos: Babbles loaded.\n\n\r\r');

        this.kidsOk = true; 

        var that = this;

        this.haschildren = this.$.parent.kids;

        document.addEventListener('user-changed', function(e){
          console.log('Values changed', e.detail.data);
        });

        document.addEventListener('has-no-kids', function(e){
          that.kidsOk = false;
        });

        document.addEventListener('has-kids', function(e){
          that.kidsOk = true;
        });

        document.addEventListener('babbel-select', function(e){
          that.previousItem = that.selectedItem;
          that.selectedItem = e.detail.key;
          that.parentItem = e.detail.parent;
          that.$.scenes.selected = 1;
        });

        document.addEventListener('babbel-terug', function(e){
          //that.previousItem = that.selectedItem;
          if(e.detail.parent){
          that.selectedItem = e.detail.parent;
          that.parentItem = that.selectedItem;
          that.$.scenes.selected = 1;
        } else {
          that.$.scenes.selected = 0;
        }
        });

        document.addEventListener('babbel-home', function(e){
          that.$.scenes.selected = 0;
          that.$.berichten.requery();
        });
      },

      datachange: function(){
        this.keys.reverse();
      },

      cdatachange: function(){
        //console.log('got it?');
        this.ckeys.reverse();
      }
    });
  </script>
</polymer-element>
