<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../ba-poster/ba-poster.html">
<link rel="import" href="../cl-voteitem/cl-voteitem.html">
<link rel="import" href="../ba-getpermissions/ba-getpermissions.html">

<link rel="import" href="../../../../elements/aos-globals/aos-globals.html">

<polymer-element name="babbel-babbel" attributes="key mode parent kids">

<template>
  <link rel="stylesheet" href="babbel-babbel.css" />

  <aos-globals id="globals" values="{{globs}}"></aos-globals>

  <firebase-element id="bericht" location="https://blazing-fire-6426.firebaseio.com/babbles/messages/{{key}}/" data="{{data}}" keys="{{keys}}" on-data-change="{{handleResponse}}"></firebase-element>
  
  <template if="{{mode=='parent'}}">
    <template if="{{data.parent!='/'}}">
      <div vertical layout start>
        <button on-tap="{{fireTerug}}">Naar vorig gesprek</button>
      </template>
      <template if="{{data.parent=='/'}}">
        <button class="backbtn" on-tap="{{fireHome}}">terug naar overzicht</button>
      </template>
      <!-- <h2>{{data.text}} {{data.votes}}</h2> -->
    </div>

    <div horizontal layout center>

      <cl-voteitem key="{{key}}" votes="{{data.votes}}" mode="{{mode}}"></cl-voteitem>

      <div vertical layout>
        <h2>{{data.text}}</h2>
        <ba-getpermissions role="{{data.role}}" usercanpost="{{usercanpost}}"></ba-getpermissions>
        <p>{{data.numchildren}} reacties -
          <template if="{{!usercanpost}}">
            <img class="lock" src="../../images/locked.svg">Enkel {{data.role}} kan reageren.
          </template>
          <template if="{{usercanpost}}">
            Jij kan reageren.
          </template>
        </p>
      </div>
    </div>

    <template if="{{$.globals.values.user}}">
      <ba-poster path="{{key}}" mode="child" role="{{data.role}}"></ba-poster>
    </template>

    <template if="{{!$.globals.values.user}}">  
      <div id="roledefinition">
        <small><a href="/#/profiel"><b>Meld je aan</b></a> om een onderwerp te starten of om te reageren.</small>
      </div>
    </template>

  </template>

  <template if="{{mode=='child'}}">
    <h4 on-tap="{{fireSelect}}">{{data.text}}</h4>
  </template>

  <template if="{{mode=='previous'}}">
    <small on-tap="{{fireTerug}}">Vorige: {{data.text}}</small>
  </template>

  <template if="{{mode=='super'}}">
    <div horizontal layout center>
      <!-- <cl-voteitem key="{{key}}" votes="{{data.votes}}" mode="parent"></cl-voteitem> -->

      <div vertical layout start>
        <h1 on-tap="{{fireSelect}}">{{data.text}}</h1>
        <cl-voteitem key="{{key}}" votes="{{data.votes}}" mode="parent"></cl-voteitem>

        <ba-getpermissions role="{{data.role}}" usercanpost="{{usercanpost}}"></ba-getpermissions><p>{{data.numchildren}} reacties - 
        <template if="{{!usercanpost}}">
          <img class="lock" src="../../images/locked.svg">Enkel {{data.role}} kan reageren.
        </template>
        <template if="{{usercanpost}}">
          Jij kan reageren.
        </template>
      </p>

    </div>
  </div>

  <hr>
</template>

</template>

<script>

  Polymer({

    ready: function(){
        //this.parent = this.data.parent;
      },

      handleResponse: function(){
        this.parent = this.data.parent;
        if(this.mode=='parent'){
          if(!this.data.children){
            this.fire('has-no-kids', {key: this.key, parent: this.parent});
          };
          if(this.data.children){
            this.fire('has-kids', {key: this.key, parent: this.parent});
            var kids = this.data.children;
            console.log('hoeveel kinderen? ',kids);
          };
        };
      },

      fireTerug: function(){
        this.fire('babbel-terug', {key: this.key, parent: this.parent});
        delete this.key;
      },

      fireHome: function(){
        this.fire('babbel-home');
        delete this.key;
      },

      fireSelect: function(){
        this.fire('babbel-select', {key: this.key, parent: this.parent});
        delete this.key;
      }

    });

</script>

</polymer-element>
