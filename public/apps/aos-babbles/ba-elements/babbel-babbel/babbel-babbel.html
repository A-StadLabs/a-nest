<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../../../elements/aos-globals/aos-globals.html">

<link rel="import" href="../cl-voteitem/cl-voteitem.html">
<link rel="import" href="../ba-getpermissions/ba-getpermissions.html">
<link rel="import" href="../time-ago/src/time-ago.html">

<link rel="import" href="../ba-poster/ba-poster.html">
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.3/moment-with-locales.min.js"></script>
<script src="../../functions.js"></script>

<polymer-element name="babbel-babbel" attributes="key mode parent kids">

<template>

  <link rel="stylesheet" href="babbel-babbel.css" />

  <aos-globals id="globals" values="{{globs}}"></aos-globals>

  <firebase-element id="bericht" location="https://blazing-fire-6426.firebaseio.com/babbles/messages/{{key}}/" orderByChild="votes" data="{{data}}" keys="{{keys}}" on-data-change="{{handleResponse}}" log></firebase-element>

  <ba-getpermissions role="{{data.role}}" usercanpost="{{usercanpost}}"></ba-getpermissions>

  <template if="{{mode=='parent'}}">
    <template if="{{data.parent!='/'}}">
      <div vertical layout start>
        <button class="prevbtn" on-tap="{{fireTerug}}">Naar vorig gesprek</button>
      </template>
      <template if="{{data.parent=='/'}}">
        <button class="backbtn" on-tap="{{fireHome}}">naar overzicht</button>
      </template>
      </div>

    <div horizontal layout start>
      <div>
      <template if="{{usercanpost}}">
        <cl-voteitem key="{{key}}" votes="{{data.votes}}" mode="{{mode}}"></cl-voteitem>
        </template>
        <template if="{{!usercanpost}}">
        <div class="voterij"><p>{{data.votes}}</p></div>
        </template>
      </div>

      <div vertical layout start flex>
        <h2>{{data.text}}</h2>
        <ba-getpermissions role="{{data.role}}" usercanpost="{{usercanpost}}"></ba-getpermissions>
        <p><img src="../../images/share3.svg" class="share" on-tap="{{sharelink}}"><time-ago datetime="{{realtime}}" refresh delay="1000"></time-ago> -  reacties -
        <template if="{{!usercanpost}}">
          <img class="lock" src="../../images/locked.svg">Enkel {{data.role}} kan reageren.
          </template>
        <template if="{{usercanpost}}">
          Jij kan reageren.
        </template> 
        </p>
      </div>
    </div>

    <template if="{{$.globals.values.user}}">
      <ba-poster path="{{key}}" mode="child" role="{{data.role}}"></ba-poster>
    </template>

    <template if="{{!$.globals.values.user}}">  
      <div id="roledefinition">
        <small><a href="/#/profiel"><b>Meld je aan</b></a> om een onderwerp te starten of om te reageren.</small>
      </div>
    </template>

  </template>

  <template if="{{mode=='super'}}">
    <div horizontal layout center>
      <div>
      <template if="{{usercanpost}}">
      <cl-voteitem key="{{key}}" votes="{{data.votes}}" mode="parent"></cl-voteitem>
      </template>
      <template if="{{!usercanpost}}">
        <div class="voterij"><p>{{data.votes}}</p></div>
        </template>
      </div>

      <div vertical layout start flex>
        <h1 on-tap="{{fireSelect}}">{{data.text}}</h1>
        <ba-getpermissions role="{{data.role}}" usercanpost="{{usercanpost}}"></ba-getpermissions><p><img src="../../images/share3.svg" class="share" on-tap="{{sharelink}}"> {{realtime}}<time-ago datetime="realtime" refresh delay="1000"></time-ago> - {{data.numchildren}} reacties - 
        <template if="{{!usercanpost}}">
          <img class="lock" src="../../images/locked.svg">Enkel {{data.role}} kan reageren.
        </template>
        <template if="{{usercanpost}}">
          Jij kan reageren.
          </template>
        </p>
      </div>

  </div>

  <hr>
  </template>

  <template if="{{mode=='child'}}">
    <div horizontal layout start>
      <div>
      <template if="{{usercanpost}}">
      <cl-voteitem key="{{key}}" votes="{{data.votes}}" mode="parent"></cl-voteitem>
      </template>
      <template if="{{!usercanpost}}">
        <div class="voterij"><p>{{data.votes}}</p></div>
        </template>
      </div>
      <div vertical layout start flex>
        <h4 on-tap="{{fireSelect}}">{{data.text}}</h4>

        <ba-getpermissions role="{{data.role}}" usercanpost="{{usercanpost}}"></ba-getpermissions><p>{{realtime}}<time-ago datetime="realtime" refresh delay="1000"></time-ago> - {{data.numchildren}} reacties - 
        <template if="{{!usercanpost}}">
          <img class="lock" src="../../images/locked.svg">Enkel {{data.role}} kan reageren.
        </template>
        <template if="{{usercanpost}}">
          Jij kan reageren.
          </template>
        </p>
      </div>
    </div>
  <hr>

    
  </template>

  <template if="{{mode=='previous'}}">
    <small on-tap="{{fireTerug}}">Vorige: {{data.text}}</small>
  </template>



</template>

<script>



  Polymer({

    ready: function(){
        //this.parent = this.data.parent;
        //this.realtime = '2014 12 16 22:28:33';

      },

      sharelink: function(){
        this.fire('share-link', { linkurl: this.key })
      },

      convertTimestamp: function(timestamp) {
        var dateTime = new Date(timestamp);
         // Returns "2013-05-31T11:54:44.000Z"
        return dateTime.toISOString();
  //return 'michael'+timestamp;
      },


      handleResponse: function(){
        this.parent = this.data.parent;

        if(this.data.time){
          this.realtime = this.convertTimestamp(this.data.time);
        };
        //console.log('tijd: ', this.realtime);
        if(this.mode=='parent'){
          if(!this.data.children){
            this.fire('has-no-kids', {key: this.key, parent: this.parent});
          };
          if(this.data.children){
            this.fire('has-kids', {key: this.key, parent: this.parent});
            var kids = this.data.children;
            //console.log('hoeveel kinderen? ',kids);
          };
        };
      },

      dataChanged: function(){
        //this.realtime = this.convertTimestamp(this.data.time);
      },

      fireTerug: function(){
        this.fire('babbel-terug', {key: this.key, parent: this.parent});
        delete this.key;
      },

      fireHome: function(){
        this.fire('babbel-home');
        delete this.key;
      },

      fireSelect: function(){
        this.fire('babbel-select', {key: this.key, parent: this.parent});
        delete this.key;
      }

    });

</script>

</polymer-element>
