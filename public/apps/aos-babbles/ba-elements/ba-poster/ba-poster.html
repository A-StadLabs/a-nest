<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../../../bower_components/core-selector/core-selector.html">
<link rel="import" href="../../../../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../../../elements/aos-globals/aos-globals.html">
<link rel="import" href="../ba-user/ba-user.html">
<link rel="import" href="../ba-setpermissions/ba-setpermissions.html">
<link rel="import" href="../ba-getpermissions/ba-getpermissions.html">

<polymer-element name="ba-poster" attributes="path mode role">
  <template>
  	<aos-globals id="globals" values="{{globs}}"></aos-globals>
  	<ba-user bauser="{{bauser}}"></ba-user>

    <link rel="stylesheet" href="ba-poster.css" />
    <div vertical layout start>

    <ba-getpermissions role="{{role}}" usercanpost="{{usercanpost}}"></ba-getpermissions>

    <input id="poster" is="core-input" value="{{valuek}}" committedValue="{{postdata}}" placeholder="Typ + enter" disabled?="{{!usercanpost}}" />

    <core-collapse id="roledefinition">
    	<small>Iedereen mag dit zien, iedereen met {{role}} mag reageren.<button class="bewerkbtn" icon="{{ roleselected ? 'lock-outline' : 'lock-open'}}" on-tap="{{toggleRoles}}">bewerken</button></small>
     </core-collapse>

    <core-collapse id="rolescoll">
    	<div on-tap="{{toggleRoles}}">x</div>
    	<ba-setpermissions id="permissions" permissions="{{permissions}}"></ba-setpermissions>
    </core-collapse>
	</div>
    <template if="{{!$.globals.values.user&&!usercanpost}}">
    	
    </template> 
</template>
<script>
    Polymer({

    	toggleRoles: function(){
    		this.$.rolescoll.toggle();
    		this.$.roledefinition.toggle();
    	},

    	ready: function(){
    		this.postdata = '';
    		this.valuek = '';
    		this.$.roledefinition.toggle();

    		this.usercanpost = false;





	  		this.$.poster.addEventListener('keypress', function(e) {
	    		if (e.keyCode == 13) {
	      			this.async(function() {
	        		that.enter();
	      			});
	    		};
	  		});

    		var that = this;

    	},



			// document.addEventListener('user-changed', function(e){
   //        		console.log('Values changed', e.detail.data);
   //        		console.log('roles: ', e.detail.data.roles);
   //        		that.checkPermissions(e.detail.data.roles);
   //      	});

	  // 		this.$.permissions.addEventListener('closethisthing', function() {
   //  			that.$.rolescoll.toggle();
   //  			that.$.roledefinition.toggle();
	  // 		});




   //  	},

   //  	checkPermissions: function(roles){
   //  		console.log('check permissions', roles);
   //  		var roles = this.globs.user.data.roles;
   //    		for (var i = roles.length - 1; i >= 0; i--) {
   //    			console.log(roles[i]);
   //    			console.log(this.role);
   //    			if(roles[i]==this.role){
   //    				console.log('found match');
   //    				this.usercanpost = true;
   //    			};
   //    		};
   //  	},

    	enter: function(){
    		var that = this;
    		if(!this.postdata==''){
    			var path = this.path
    			var valuek = this.valuek;
    			var role = this.role;
    			console.log('Saven maar: ', this.valuek);
    			var name = '';
    			var userFB = new Firebase("https://blazing-fire-6426.firebaseio.com/babbles/messages/");
	    		var newpostRef = userFB.push({"text":valuek, "parent":path, "role":role});
	    		var newKey = newpostRef.key();
	    		if(this.mode=='child'){
	    			// var userFB1 = new Firebase("https://blazing-fire-6426.firebaseio.com/babbles/parents/"+path+"/children/"+newKey+"/");
	    			// var newpostRef1 = userFB1.set({"text":valuek, "parent":path});

					var userFB2 = new Firebase("https://blazing-fire-6426.firebaseio.com/babbles/messages/"+path+"/children/"+newKey+"/");
					userFB2.set({"child": true});
				};
				// if(this.mode=='parent'){
				// 	var userFB2 = new Firebase("https://blazing-fire-6426.firebaseio.com/babbles/parents/"+newKey+"/");
				// 	userFB2.set({"parent": true});
				// }
	    		
	    		delete userFB;
	    		delete this.valuek;
	    		delete path;
	    		delete this.path;
   		
    		}
    	}

    });
</script>
</polymer-element>