<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../../../elements/aos-globals/aos-globals.html">


<polymer-element name="babbel-postcomment" attributes="tags op mother roles">

   <link rel="stylesheet" href="../../aos-babbelroot.css" />
  <template>
<!--     <link rel="stylesheet" href="babbel-postcomment.css" />
 -->     

        <aos-globals id="globals"></aos-globals>




<div if="{{unlocked}}">

    <core-ajax 
  id="ajaxBabbelbox" 
  url="https://blazing-fire-6426.firebaseio.com/babbelbox/babbels/.json"
  method="POST" 
  handleAs="json" 
  response="{{postResponse}}"
  on-core-response="{{handleResponse}}">
  </core-ajax>

<div id="newitem" vertical layout start>

  <div horizontal layout center wrap>


    <input autofocus placeholder="Begin een gesprek" value="{{newConversation}}" id="newConv">



    <div id="inputbtns" horizontal layout center>
    
      <button id="submitbtn" on-tap="{{submitNewConversation}}">OK</button>
    </div>
  </div>


<!--     <div id="" horizontal layout start start-justified wrap>
      <button class="itemaddons">tag toevoegen</button>
      <button class="itemaddons">bestand toevoegen</button>
    </div> -->

</div>
</div>

<div if="{{!unlocked}}">
<h1>niet de juiste rechten, (je hebt {{roles}} nodig).</h1>
</div>

  </template>

  <script>

    Polymer({

      ready: function() {
      	console.log('Babbelbox entry loaded.'); 
        this.unlocked = false;

        var that = this;
        
        document.addEventListener('user-changed', function(){
          console.log('value changed from postcomment');
          console.log('HELLOO//////     \n\n'+that.roles+' vs '+that.$.globals.values.user);
          var givenroles = that.$.globals.values.user.data.roles;
          var askedroles = that.roles;

          // ga door de roles en vind een match
          for (var i = givenroles.length - 1; i >= 0; i--) {
            if(givenroles[i]==askedroles){
              console.log('granted!');
              that.unlocked = true;
            } else {
              console.log('cant post here');

            }
          };


        });
      },

     



      // Nieuwe conversatie opslaan
      submitNewConversation: function(){
          this.time = new Date();
          this.postBody = { 'time': this.time, 'title': this.newConversation, 'tags':this.tags, 'op': this.op, 'mother': this.mother, 'votes': 1, 'children': 0 };
          this.$.ajaxBabbelbox.body = JSON.stringify(this.postBody);
          this.$.ajaxBabbelbox.go();
          this.$.newConv.value = '';

           var addPlay = new Firebase('https://blazing-fire-6426.firebaseio.com/babbelbox/babbels/'+this.mother+'/children/');
          addPlay.transaction(function(currentRank) {
            return currentRank+1;
          });


      }
      
      

    });

  </script>

</polymer-element>
