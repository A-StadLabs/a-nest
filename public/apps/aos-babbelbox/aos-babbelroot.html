<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="../../bower_components/polymer-filters/polymer-filters.html">


<!-- Hier staat onze custom elementen -->
<link rel="import" href="elements/babbel-babbel/babbel-babbel.html">
<link rel="import" href="elements/babbel-postcomment/babbel-postcomment.html">
<link rel="import" href="elements/babbel-subposts/babbel-subposts.html">

<polymer-element name="aos-babbelroot" attributes="">
<template>

    <link rel="stylesheet" href="aos-babbelroot.css" /> 


<firebase-element id="FBgeneral" location="https://blazing-fire-6426.firebaseio.com/babbelbox/" orderByChild="op" equalTo="1" data="{{data}}" keys="{{keys}}" on-data-change="{{handleResponse}}" id="fbBabbelbox"></firebase-element>

<core-animated-pages id="babbelscenes"  transitions="slide-from-right"> 
<section>



<!-- <h1>Babbelbox right?</h1>
 -->
  <div class="leaderboard">
    <img class="stralendeA" src="images/astadlabs.svg">
    <div horizontal layout wrap center start-justified>
      <div horizontal layout wrap center start-justified flex>
        <img class="appicon" src="images/babbelbox.svg">
        <h1>Babbles</h1><input type="text" on-keyup="{{filter}}" class="searchbox">
      </div>


    </div>
  </div>






<div id="generalsort" horizontal layout center start-justified >
  <button class="startbtn" on-tap="{{openadd}}" horizontal layout center start-justified ><img src="images/nieuw.svg">Begin een Babble</button>
<p>  Sorteer op </p>
<button class="sortbtn" on-tap="{{sortthis}}">meeste votes</button>
<button class="sortbtn" on-tap="{{sorttime}}">Meest recent</button>
<button class="sortbtn" on-tap="{{sortchild}}">Meest antwoord</button>
</div>


<core-collapse id="startConv">
<babbel-postcomment op="1" tags="OP" mother="0"></babbel-postcomment>
</core-collapse>



<core-selector selected="{{selected}}" id="selektor">

<template repeat="{{d, i in opdata }}">
<div class="babbelbabbel">
		<babbel-babbel key="{{d.key}}" object="{{d}}" mode="parent" childOf="0"></babbel-babbel>
		<core-collapse opened?="{{selected == i}}">
			<babbel-subposts mother="{{d.key}}"></babbel-subposts>
		</core-collapse>
</div>
</template>

</core-selector>
</section>
<!--  Hier gaan we dieper in een post -->
<section>


	<babbel-babbel key="{{selKey}}" object="{{selObject}}" mode="parent" childOf="0"></babbel-babbel>
	<babbel-postcomment op="0" tags="child" mother="{{selKey}}"></babbel-postcomment>

	<template repeat="{{k in keys}}">
		<template if="{{data[k].mother==selKey}}">
			<babbel-babbel key="{{k}}" object="{{data[k]}}" mode="child" childOf="{{selKey}}" parentObject="{{selObject}}"></babbel-babbel>
		</template>
	</template>
</section>
</core-animated-pages>

</template>
<script>

var opdata = [];

    Polymer({

      opdataChanged: function(){
        console.log('Opdata changed; ',this.opdata);
        this.$.selektor.selected = -1;
      },

      openadd: function(){
        this.$.startConv.toggle();
        this.$.selektor.selected = -1;
      },

      sorting: function(a,b) {
        if (a.votes < b.votes)
          return -1;
        if (a.votes > b.votes)
          return 1;
        return 0;
      },

      sortthis: function(){
        console.log('sorteren', this.opdata);

        this.opdata.sort(this.sorting);

        this.opdata.reverse();

        console.log('gesorteerd', this.opdata);
      },

      sorttime: function() {
        this.handleResponse();
      },

      sortnumChild: function(a,b) {
        if (a.children < b.children)
          return -1;
        if (a.children > b.children)
          return 1;
        return 0;
      },

      sortchild: function(){
        console.log('sorteren', this.opdata);

        this.opdata.sort(this.sortnumChild);

        this.opdata.reverse();

        console.log('gesorteerd', this.opdata);
      },


      

    	ready: function(){

        this.filteredkeys = this.keys;

    		var that = this;

    		//this.$.selektor.selected = 2;

    		// document.addEventListener('babbel-select', function(e){
      //     		console.log('selected someo shit!', e.detail.key);
      //     		that.selKey = e.detail.key;
      //     		that.selObject = that.data[e.detail.key];
      //     		that.$.babbelscenes.selected = 1;
      //   	});

      //   	document.addEventListener('babbel-open', function(e){
      //     		console.log('selected someo shit!', e.detail.mother);
      //     		that.selKey = e.detail.mother;
      //     		that.selObject = that.data[e.detail.mother];
      //     		that.$.babbelscenes.selected = 1;
      //   	});

    		this.$.selektor.addEventListener('core-activate', function(e){
          		console.log('selected someo shit!', e.detail, this.selected);
          		
        	});

    	},

    	handleResponse: function(){
        var opdata = [];
        var keys = this.keys;
        console.log(JSON.stringify());
        for (var i = keys.length - 1; i >= 0; i--) {
          console.log(this.data[keys[i]]);
          console.log(this.name);
          opdata.push({ 'key': keys[i],
                        'title': this.data[keys[i]].title,
                        'votes': this.data[keys[i]].votes,
                        'op': this.data[keys[i]].op,
                        'children': this.data[keys[i]].children,
                        'mother': this.data[keys[i]].mother,
                        'time': this.data[keys[i]].time,
                        'tags': this.data[keys[i]].tags
                      });
        };
        this.opdata = opdata;
    	},

      sort: function(value, term){
        return value;
      }
    });

</script>
</polymer-element>