<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../elements/aos-comment/aos-comment.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="elements/time-ago/src/time-ago.html">
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.3/moment-with-locales.min.js"></script>

<link rel="import" href="../../bower_components/core-drawer-panel/core-drawer-panel.html">
<polymer-element name="aos-babbelbox" attributes="">

  <template>

    <link rel="stylesheet" href="aos-babbelbox.css" />




 <div class="leaderboard">
    <img class="stralendeA" src="images/a-rgb.svg">
    <div horizontal layout wrap center start-justified>
      <div horizontal layout wrap center start-justified>
        <img class="appicon" src="images/babbelbox.svg">
        <h1>Babbelbox</h1>
        <!-- <input type="text" on-keyup="{{filter}}" class="searchbox"> -->
      </div>

       
       <!--  <firebase-element location="https://blazing-fire-6426.firebaseio.com/babbelbox" orderByChild="votes" data="{{data}}" keys="{{keys}}" on-data-change="{{handleResponse}}" id="fbBabbelbox"></firebase-element> -->

    </div>
  </div>

<div class="container">


<core-animated-pages id="babbelscenes"  transitions="slide-from-right"> 


<section>
<div id="toolbarbtns" horizontal layout start wrap>

  <button id="newconv" on-tap="{{toggleInput}}"> <div horizontal layout center><img class="new" src="images/nieuw.svg">
nieuw gesprek</div></button>

  <core-ajax 
  id="ajaxBabbelbox" 
  url="https://blazing-fire-6426.firebaseio.com/babbelbox/.json"
  method="POST" 
  handleAs="json" 
  response="{{postResponse}}"
  on-core-response="{{handleResponse}}">
  </core-ajax>

   <core-dropdown-menu label="sorteren" class="sortbtns">
          <core-dropdown class="dropdown">
            <core-selector selected="0" id="lanselect" valueattr="label">
              <core-item label="Chronologisch"></core-item>
              <core-item label="Alfabetisch"></core-item>
            </core-selector>
          </core-dropdown>
  </core-dropdown-menu>

   <core-dropdown-menu label="reach" class="sortbtns">
          <core-dropdown class="dropdown">
            <core-selector selected="0" id="lanselect" valueattr="label">
              <core-item label="Alle gesprekken"></core-item>
              <core-item label="enkele speficieke gesprekken"></core-item>
            </core-selector>
          </core-dropdown>
  </core-dropdown-menu>
</div>


<div class="canvas">


<core-collapse id="collapse">
<div id="newitem" vertical layout start>
<input autofocus placeholder="Begin een gesprek" value="{{newConversation}}" id="newConv">

  <div id="" horizontal layout start start-justified wrap>
    <button class="itemaddons">tag toevoegen</button>
    <button class="itemaddons">bestand toevoegen</button>
  </div>


  <div id="inputbtns" horizontal layout center end-justified>
    <p on-tap="{{toggleInput}}">annuleren</p>
    <button id="submitbtn" on-tap="{{submitNewConversation}}">OK</button>
  </div>

</div>
</core-collapse>


<core-selector id="convselector" selected="{{selected}}" valueattr="value" on-core-select="">


  <template repeat="{{k in keys}}">
    <div class="convitem" horizontal layout start start-justified>
      <div class="updownbtns" vertical layout center>
        <button on-tap="{{upVote}}" key="{{k}}"><img class="updownimg" src="images/up.svg"></button>
        <p>{{data[k].votes}}</p>
        <button on-tap="{{downVote}}" key="{{k}}"><img class="updownimg" src="images/down.svg"></button>
      </div>
      <div class="convcontent" vertical layout start>
      <h1 on-tap="{{gotoDetail}}" key="{{k}}" name="convSelected">{{data[k].title}}</h1>
        <small><time-ago datetime="{{data[k].time}}"></time-ago> | <span class="convcomments"> 112 reacties </span> </small>
        


      </div>

    </div>
  </template>
  

</core-selector>  
</section>







<section>
<div class="canvas">

  <firebase-element location="https://blazing-fire-6426.firebaseio.com/babbelbox/{{selectedItem}}/" childEvents orderByChild="votes" data="{{data2}}" keys="{{keys2}}" on-data-change="{{handleResponse2}}" id="fbBabbelboxDetail" log></firebase-element>

  <div id="detail">
    <template bind>
    <small on-tap="{{gotoList}}">back</small>
    <h1>{{data2.title}}</h1>
    </template>
  </div>
</div>
</section>


</core-animated-pages> 

</div>



</div>



  </template>

  <script>

    Polymer({

      ready: function() {

        var ref = new Firebase("https://blazing-fire-6426.firebaseio.com/babbelbox");
        var data = '';
        ref.orderByChild("votes").on("child_added", function(snapshot) {
          //console.log(snapshot.key() + " was " + snapshot.val().votes + " meters tall");
          data = data + snapshot.key() + " was " + snapshot.val().votes;
      });
        console.log('data: ',data);
        this.data = data;
        },

      toggleInput: function(){
        this.$.collapse.toggle();
        this.$.toolbarbtns.hidden = !this.$.toolbarbtns.hidden;
        this.$.newConv.value = '';
      },

      gotoDetail: function(e, detail, sender) {
        this.$.babbelscenes.selected = 1;
        this.selectedItem = sender.attributes[1].value;
      },

      gotoList: function() {
        this.$.babbelscenes.selected = 0;
      },

      // Nieuwe conversatie opslaan
      submitNewConversation: function(){
          this.time = new Date();
          this.postBody = { 'time': this.time, 'title': this.newConversation, 'tags':'antwerpen' };
          this.$.ajaxBabbelbox.body = JSON.stringify(this.postBody);
          this.$.ajaxBabbelbox.go();
          this.$.newConv.value = '';
      },

      handleResponse: function(){
          this.data.sort(function(a, b){return b-a});
      },

      handleResponse2: function(){
        console.log(JSON.stringify(this.data2.title));
      },

      upVote: function(e, detail, sender){
          this.key = sender.attributes[1].value;
          var addPlay = new Firebase('blazing-fire-6426.firebaseio.com/babbelbox/'+this.key+'/votes');

          addPlay.transaction(function(currentRank) {
           // If /users/fred/rank has never been set, currentRank will be null.
             return currentRank+1;
           });
      },

      downVote: function(e, detail, sender){
          this.key = sender.attributes[1].value;
          var addPlay = new Firebase('blazing-fire-6426.firebaseio.com/babbelbox/'+this.key+'/votes');

          addPlay.transaction(function(currentRank) {
           // If /users/fred/rank has never been set, currentRank will be null.
             return currentRank-1;
           });
      }

      


    });

  </script>

</polymer-element>
