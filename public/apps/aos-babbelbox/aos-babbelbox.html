<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../elements/aos-comment/aos-comment.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">

<link rel="import" href="elements/babbel-babbel/babbel-babbel.html">
<link rel="import" href="elements/babbel-comment/babbel-comment.html">
<link rel="import" href="elements/babbel-detail/babbel-detail.html">
<link rel="import" href="elements/babbel-postcomment/babbel-postcomment.html">
<link rel="import" href="elements/babbelbox-comments/babbelbox-comments.html">


<link rel="import" href="../../bower_components/core-drawer-panel/core-drawer-panel.html">
<polymer-element name="aos-babbelbox" attributes="">

  <template>

    <link rel="stylesheet" href="aos-babbelbox.css" />

    <firebase-element id="FBgeneral" location="https://blazing-fire-6426.firebaseio.com/babbelbox" orderByChild="votes" data="{{data}}" childEvents on-child-added="{{childAdded}}" keys="{{keys}}" on-data-change="{{handleResponse}}" id="fbBabbelbox"></firebase-element>


 <div class="leaderboard">
    <img class="stralendeA" src="images/a-rgb.svg">
    <div horizontal layout wrap center start-justified>
      <div horizontal layout wrap center start-justified>
        <img class="appicon" src="images/babbelbox.svg">
        <h1>Hoe heet deze app?</h1>
        <!-- <input type="text" on-keyup="{{filter}}" class="searchbox"> -->
      </div>
       
        

    </div>
  </div>

<div class="container">


<core-animated-pages id="babbelscenes"  transitions="slide-from-right"> 


<section>
<div id="toolbarbtns" horizontal layout start wrap>

  <button id="newconv" on-tap="{{toggleInput}}"> <div horizontal layout center><img class="new" src="images/nieuw.svg">
nieuw gesprek</div></button>

   <core-dropdown-menu label="sorteren" class="sortbtns">
          <core-dropdown class="dropdown">
            <core-selector selected="0" id="lanselect" valueattr="label">
              <core-item label="Chronologisch"></core-item>
              <core-item label="Alfabetisch"></core-item>
            </core-selector>
          </core-dropdown>
  </core-dropdown-menu>

   <core-dropdown-menu label="reach" class="sortbtns">
          <core-dropdown class="dropdown">
            <core-selector selected="0" id="lanselect" valueattr="label">
              <core-item label="Alle gesprekken"></core-item>
              <core-item label="enkele speficieke gesprekken"></core-item>
            </core-selector>
          </core-dropdown>
  </core-dropdown-menu>
</div>

<!-- Dit is de core-ajax die een nieuw bericht post -->
<!-- <core-ajax 
  id="ajaxBabbelbox" 
  url="https://blazing-fire-6426.firebaseio.com/babbelbox/.json"
  method="POST" 
  handleAs="json" 
  response="{{postResponse}}"
  on-core-response="{{handleResponse}}">
  </core-ajax> -->

<div class="canvas">

<core-collapse id="collapse">
  <babbel-postcomment op="1" tags="OP" mother="0"></babbel-postcomment>
</core-collapse>

<!-- Hier begint de lijst van berichten -->

<template repeat="{{k in opdata}}" id="repeater">

  <template if="{{k.op==1}}">
      <babbel-babbel key="{{k.key}}" object="{{k}}" mode="parent" childOf="{{k.mother}}"></babbel-babbel>
  </template>

</template>

</section>

<!-- einde lijst berichten -->


<!-- in deze sectie zit het detail van het bericht -->

<section>
<div class="canvas">
  <div class="back">
    <small on-tap="{{gotoList}}">< terug naar lijst</small>
  </div>

  <div id="detail" vertical layout start>

  <babbel-detail object="{{selObject}}" key="{{selKey}}"></babbel-detail>

  

  <div id="selfcomment">
    <babbel-postcomment mother="{{selKey}}" op="0" tags="{{selObject.title}}"></babbel-postcomment>
  </div>

<div id="currentcomments">
    <babbelbox-comments key="{{selKey}}"></babbelbox-comments>
</div>

  </div>
</div>
</section>


</core-animated-pages> 

</div>



</div>



  </template>

  <script>

    var opdata = [];

    Polymer({

      childAdded: function(){
        var that = this;
        console.log('added ', event.detail.name, ':', event.detail.value);
            opdata.push({ 
              'key': event.detail.name,
              'title': event.detail.value['title'], 
              'tags': event.detail.value['tags'], 
              'votes': event.detail.value['votes'],
              'op': event.detail.value['op'],
              'mother': event.detail.value['mother'],
              'time': event.detail.value['time']});

        console.log(opdata);
      },

      ready: function() {

        this.opdata = opdata;
        this.childdata = childdata;

        var that = this;
        
        // this.$.FBgeneral.addEventListener('child-added',function(){
        //   var that = this;
        //   console.log('added ', event.detail.name, ':', event.detail.value);
        //   if(event.detail.value['op']===1){
        //     opdata.push({ 'title': event.detail.value['title'], 'tags': event.detail.value['tags'], 'time': event.detail.value['time']});
        //   };
        //   console.log(opdata);
        // });

        document.addEventListener('babbel-select', function(e, detail, sender){
          //console.log('selected someo shit!', e.detail.key, detail, sender);
          that.selKey = e.detail.key;
          that.selObject = that.data[e.detail.key];
          that.$.babbelscenes.selected = 1;
        });

        document.addEventListener('go-home', function(){
          delete that.selKey;
          delete that.selObject;
          that.$.babbelscenes.selected = 0;
        });

        

      },

      toggleInput: function(){
        this.$.collapse.toggle();
        this.$.toolbarbtns.hidden = !this.$.toolbarbtns.hidden;
        this.$.newConv.value = '';
      },

      gotoList: function() {
        this.$.babbelscenes.selected = 0;
      },

      // Nieuwe conversatie opslaan
      submitNewConversation: function(){
          this.time = new Date();
          this.postBody = { 'time': this.time, 'title': this.newConversation, 'tags':'antwerpen' };
          this.$.ajaxBabbelbox.body = JSON.stringify(this.postBody);
          this.$.ajaxBabbelbox.go();
          this.$.newConv.value = '';
      },

      submitNewComment: function() {
          this.time = new Date();
          this.commentBody = { 'time': this.time, 'title': this.NewComment, 'tags':'antwerpen' };
          this.$.ajaxComments.body = JSON.stringify(this.commentBody);
          this.$.ajaxComments.go();
          //this.$.newConv.value = '';
      },

     
      

      


    });

  </script>

</polymer-element>
