<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../aos-globals/aos-globals.html">
<link rel="import" href="../aos-user/aos-user.html">
<link rel="import" href="../aos-dial/aos-dial.html">
<link rel="import" href="../../bower_components/core-icon-button/core-icon-button.html">

<link rel="import" href="../../bower_components/core-overlay/core-overlay.html">

<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../aos-render/aos-render.html">
 
<link rel="import" href="../aos-edit/aos-edit.html">

<polymer-element name="aos-useruniverse" attributes="key userid selectedObject">
  <template>
    <link rel="stylesheet" href="aos-useruniverse.css" />
    <aos-globals id="globals"></aos-globals>
    <aos-user key="{{$.globals.values.user.data.id}}" aosuser="{{aosuserobject}}" favapps="{{favapps}}"></aos-user>

<!--     <h1>{{selectedObject}}</h1>
 -->    
    <!-- <p>dit is een heel nieuwe manier om blablaba. Wil je starten?</p>
    <button on-tap="{{activate}}">activeer nieuwe filosofie</button>
    nieuw component dat toelaat om te zien welke items ik kan koppelen aan dit item. -->
    <!-- hier komt het coponent dat de root laat zien + mogelijke children -->

    <div class="canvas" horizontal layout start start-justified wrap>
       <div horizontal layout start start-justified class="profilebox">
        <div horizontal layout center flex>
            <div class="avatarbox">
                <img src="{{$.globals.values.user.data.avatarUrl}}">
            </div>  
            <h1 hidden?="{{editmode}}">Ben Adriaenssen</h1>

             <aos-edit id="editor" opened="{{editmode}}" userid="{{userid}}" value="{{value}}" type="{{type}}" instance="{{instance}}" flex></aos-edit>      
        </div>


        <div horizontal layout hidden?="{{editmode}}">
            <button class="btn" on-tap="{{showEdit}}">
                <svg version="1.1" id="Laag_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     width="30px" height="30px" viewBox="0 0 30 30" enable-background="new 0 0 30 30" xml:space="preserve">
                <path d="M14.942,29.084c-3.74,0-7.255-1.456-9.899-4.102c-2.645-2.644-4.102-6.16-4.102-9.898
                    S2.398,7.83,5.043,5.185c2.644-2.645,6.16-4.101,9.899-4.101c3.74,0,7.254,1.457,9.899,4.101c2.646,2.645,4.101,6.16,4.101,9.899
                    c0,3.739-1.455,7.255-4.101,9.898C22.197,27.628,18.682,29.084,14.942,29.084z M14.942,2.158c-3.452,0-6.699,1.344-9.14,3.786
                    c-2.441,2.441-3.786,5.688-3.786,9.14c0,3.452,1.345,6.699,3.786,9.141c2.441,2.44,5.688,3.786,9.14,3.786
                    c3.452,0,6.699-1.343,9.14-3.786c2.442-2.441,3.786-5.688,3.786-9.141c0-3.453-1.344-6.699-3.786-9.14
                    C21.64,3.501,18.396,2.158,14.942,2.158z"/>
                <path d="M12.118,19.947c-0.628-0.397-1.281-0.702-1.935-0.919L9.954,23.41l3.811-2.117
                    C13.293,20.797,12.74,20.342,12.118,19.947z"/>
                <path d="M19.951,7.59c-0.997-0.633-1.981-0.835-1.981-0.835l-6.946,10.941c0.659,0.238,1.305,0.556,1.922,0.946
                    c0.612,0.386,1.17,0.832,1.665,1.32L21.553,9.03C21.552,9.028,20.948,8.223,19.951,7.59z"/>
                </svg>
            </button>

        </div>


    </div>
            <button class="plus" on-tap="{{showMagnets}}" vertical layout center center-justified>
                <svg version="1.1" id="Laag_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     width="60px" height="60px" viewBox="0 0 60 60" enable-background="new 0 0 60 60" xml:space="preserve">
                <polygon fill="#FFFFFF" points="44.03,27.615 31.577,27.615 31.577,13.777 27.424,13.777 27.424,27.615 14.969,27.615 
                    14.969,31.768 27.424,31.768 27.424,44.223 31.577,44.223 31.577,31.768 44.03,31.768 "/>
                </svg>

            </button>

    
   

    <!-- en hier komt dan nog de "dial" -->
    <aos-dial key="{{selectedObject}}" opened="{{openDial}}"></aos-dial>
       

    <template bind if="{{ selectedObject != '-JgME4mVsCnPEDxM4K1e' }}">
        <aos-render type="{{selectedObject}}" userid="{{aosuserobject.aosuser.id}}" mode="parent" instance="{{selectedInstance}}" hidden?="{{selectedItem}}"></aos-render>
    </template>
    
    <div id="kinderen" horizontal layout start>
    
        <template repeat="{{k, i in userObjects}}">
            <aos-render type="{{k.type}}" userid="{{aosuserobject.aosuser.id}}" mode="child" instance="{{k.key}}"></aos-render>
        </template>

    </div>
</div>
</template>
<script>
    Polymer({

        ready: function(){
            var that = this;

            this.openDial = false;

            this.editmode = false;

            this.userObjects = [];
            
            this.selectedObject = '-JgMNM0jZQWX6QJZ9tLD';

            //this.getObjects();

            var that = this;

            this.addEventListener('item-select', function(e){
                that.selectedObject = e.detail.msg;
                that.selectedInstance = e.detail.instance;
                //console.log('heard you, you winer&: ', e.detail.msg, ' instance: ', e.detail.instance);
            });

            this.$.editor.addEventListener('cancel', function(){
                that.showEdit();
            }); 


        },

        showEdit: function(){
            this.editmode = !this.editmode;
        },

        showMagnets: function(){
            this.openDial = !this.openDial;
        },

        getMagnets: function(){
            //var key = '-JgME4mVsCnPEDxM4K1e';
            var selectedObject = this.selectedObject;
            var getMagnets = new Firebase("https://blazing-fire-6426.firebaseio.com/eobjects/things/"+selectedObject+"/children/");
            var objectMagnets = [];

          var respObjects = getMagnets.on("child_added", function(snap){
            objectMagnets.push({'naam':snap.val().naam, 'icon':snap.val().icon, 'key': snap.val().childKey});
            //console.log('naam',snap.val().naam, 'icoon', snap.val().icon, 'key', snap.key());
          });

          this.objectMagnets = objectMagnets;

          this.magnets = true;

          //if(objectMagnets.length<0){ this.magnets = false };
          //console.log('magnets: ', this.magnets);    
          
        },

        selectitem: function(e, detail, sender){
          //console.log(sender.attributes.type.value);
          this.selectedItem = sender.attributes.type.value;
        },

        selectedObjectChanged: function(){
            //this.getObjects();
            //console.log('key changed');
            this.getObjects();
            this.getMagnets();
    	},

    	getObjects: function(){
    		// Get kids
            //console.log('starting to get kids');
    		var that = this;
    		var key = this.key;
            //var key = this.aosuserobject.aosuser.id;
            var selectedObject = this.selectedObject;
    		//var getObjects = new Firebase("https://blazing-fire-6426.firebaseio.com/eobjects/things/"+selectedObject+"/children/");
            var getObjects = new Firebase("https://blazing-fire-6426.firebaseio.com/universe/user/"+key+"/things/"+selectedObject+"/children/");
    		var userObjects = [];
    		var respObjects = getObjects.on("child_added", function(snap){
    			console.log(snap.val(), snap.key());
            	userObjects.push({'type':snap.val().type, 'key': snap.key()});
            	console.log(userObjects);
            	that.userObjects = userObjects;
            	console.log(that.userObjects);
          	});
    	},

        aosuserobjectChanged: function(){
            //if(this.aosuserobject.aosuser.id){
            //console.log('ahahahahahahA!!!!!!', this.aosuserobject.aosuser.id);
            this.key = this.aosuserobject.aosuser.id;
            this.getObjects();
            this.getMagnets();

        },

    	activate: function(){
    		var key = this.key;
            var selectedObject = this.selectedObject;

    		var startUniverse = new Firebase("https://blazing-fire-6426.firebaseio.com/universe/user/"+key+"/values/"+selectedObject+"/");

    		var respUniverse = startUniverse.set(key);

    		var startRoot = new Firebase("https://blazing-fire-6426.firebaseio.com/universe/user/"+key+"/things/");
    		startRoot.push({'type':selectedObject});
    	}

    });
</script>
</polymer-element>