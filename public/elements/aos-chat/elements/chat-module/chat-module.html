<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../../aos-globals/aos-globals.html">

<polymer-element name="chat-module" attributes="conversation">

  <template>

    <link rel="stylesheet" href="chat-module.css" />
    <aos-globals id="globals" on-values-changed="{{test}}" values="{{globs}}"></aos-globals>

    <firebase-element id="chatmsgs" location="https://blazing-fire-6426.firebaseio.com/chat/things/{{conversation}}/" data="{{data}}" keys="{{keys}}" on-data-change="{{datachange}}" log></firebase-element>

    <firebase-element id="convdata" location="https://blazing-fire-6426.firebaseio.com/chat/directory/{{$.globals.values.user.data.id}}/chats/{{conversation}}/" data="{{cdata}}" keys="{{ckeys}}" on-data-change="{{cdatachange}}" log></firebase-element>

    <div class="chatlistitem" horizontal layout center start-justified class="status">
      <img class="chatavatar" src="{{cdata.avatar}}">
      <p>{{cdata.with}}</p>
    </div>
    <div class="msgcont">
    <template repeat="{{k in keys}}">
      <small>{{data[k].owner}}</small>
      <p>{{data[k].msg}}</p>
    </template>
    </div>
    
    <div vertical layout left end-justified>
      <input type="text" id="chatinput" value="{{chatmsg}}" placeholder="Typ iets" />
    </div>

    
  </template>

  <script>

    Polymer({

      ready: function() {
        this.userid = this.$.globals.values.user.data.id;
        var that = this;

        this.$.globals.addEventListener('values-changed', function(){
          console.log(that.$.globals.values.user.data.id);
        });

        this.$.chatinput.addEventListener('keypress', function(e){
          var userid = that.$.globals.values.user.data.id;
          var owner = that.owner;
          var guest = that.guest;
          var msg = that.chatmsg;
          var conversation = that.conversation;
          if (e.keyCode == 13) {
            console.log(that.chatmsg);
            var FBcheck = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/things/"+conversation+"/");
            FBcheck.push({ "owner": userid, 
                          "msg": msg,
                           "time":Firebase.ServerValue.TIMESTAMP });

            //var FBlastpost = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/conversations/"+owner+"/"+guest+"/lastpost/");
            //FBlastpost.set(Firebase.ServerValue.TIMESTAMP);
            that.chatmsg = '';
          };
        }); 
      },

      datachange: function(){
        //console.log('data caged');
        this.keys.reverse();
      },

      cdatachange: function(){
        console.log('data caged', this.cdata);
      }

      

    });

  </script>

</polymer-element>
