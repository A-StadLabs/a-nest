<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<link rel="import" href="../aos-globals/aos-globals.html">

<polymer-element name="aos-chat" attributes="user">
  <template>
    <link rel="stylesheet" href="aos-chat.css">
    <aos-globals id="globals" on-values-changed="{{test}}" values="{{globs}}"></aos-globals>

    <core-ajax id="finduser" on-core-response="{{userresp}}" response="{{userresponse}}"></core-ajax>

    <template if="{{$.globals.values.user}}">
      <div id="chatcontainer" class="container {{ {open: chatopened} | tokenList}}" vertical layout start start-justified>

        <div>




        <template if="{{!chatactive}}">

          <div id="chatstatus"  on-tap="{{toggle}}">
            <p>Chat (inactief) {{user}}</p>
          </div>

          <div class="chatlist" hidden?="{{!chatopened}}">
            <p>Vanaf nu kan je ook chatten! Wil je de chatfunctie activeren?</p>
            <button on-tap="{{activateChat}}">Activeer chat</button>
          </div>

        </template>
          
        <template if="{{chatactive}}">
        
          <div id="chatstatus"  on-tap="{{toggle}}">
            <p>Je bent online</p>
          </div>

          <div class="chatlist" hidden?="{{!chatopened}}">
            <input type="text" id="gebruikercheck" value="{{uservalue}}" placeholder="Gebruikersnaam" />
            <template repeat="{{s, i in users}}">
              <core-selector valueattr="key" selected="{{uservalue}}">
                <div class="item" key="{{users[i].id}}"><p key="{{users[i].id}}">{{users[i].username}}</p></div>
              </core-selector>
            </template>
          </div>

          <!-- <div id="chatlist" hidden?="{{!chatopened}}">
            <div class="chatlistitem" horizontal layout center start-justified>
              <img class="chatavatar" src="{{$.globals.values.user.data.avatarUrl}}">
              <p>Username</p>
            </div>
            <div class="chatlistitem" horizontal layout center start-justified>
              <img class="chatavatar" src="{{$.globals.values.user.data.avatarUrl}}">
              <p>Username</p>
            </div>
            <div class="chatlistitem" horizontal layout center start-justified>
              <img class="chatavatar" src="{{$.globals.values.user.data.avatarUrl}}">
              <p>Username</p>
            </div>
            <div class="chatlistitem" horizontal layout center start-justified>
              <img class="chatavatar" src="{{$.globals.values.user.data.avatarUrl}}">
              <p>Username</p>
            </div>
          </div> -->

        </template>

        </div>
      </div>
    </template>
    <template if="{{!$.globals.values.user}}">
     
    </template>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        // define element prototype here

      ready: function() {
        this.chatactive = false;

        var that = this;

        document.addEventListener('user-changed', function(e){
          console.log('nu ken ik de user wel.', that.$.globals.values.user.data.id);

          var userid = that.$.globals.values.user.data.id;

          console.log('en ik vertaal: ', userid);

          that.checkUserChatActive(userid);

        });

        document.addEventListener('keypress', function(e) {
          var ajax = that.$.finduser;
          console.log('value: ', that.uservalue);
          if (e.keyCode == 13) {
          };

          that.$.finduser.url = "/gebruiker/?search="+that.uservalue;
          ajax.go();
          
          
          
        });
        
      },

      userresp: function(){
        this.users = JSON.parse(this.userresponse);
        //this.users = this.users.data;
      },

      checkUserChatActive: function(userid){
        var that = this;
        var FBcheck = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/users/"+userid+"/");
          FBcheck.once('value', function(dataSnapshot) {
          // code to handle new value.
            console.log('is de chat actief? ', dataSnapshot.val());
            that.chatactive = dataSnapshot.val();
          });
      },

      toggle: function() {
        this.chatopened = !this.chatopened;
      },

      activateChat: function(){
        var userid = this.$.globals.values.user.data.id;
        var user = this.$.globals.values.user.data.username;
        var firstname = this.$.globals.values.user.data.firstName;
        var lastname = this.$.globals.values.user.data.lastName;
        var email = this.$.globals.values.user.data.email;

        var FBchat = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/users/"+userid+"/");
        var newpostRefa = FBchat.set(true);

        var FBchatuser = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/users/"+userid+"/username/");
        var newpostRefb = FBchatuser.set(user);

        var FBsaveuser = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/directory/");
        var DirectoryResult = FBsaveuser.push({
          "userid":userid, 
          "username": user, 
          "firstname":firstname, 
          "lastname": lastname, 
          "email": email,
          "time":Firebase.ServerValue.TIMESTAMP
        });

        //var newKey = newpostRefa.key();
        //console.log('New chatmessage saved at: '+newKey);
        this.checkUserChatActive(userid);
      }

      });

    })();
  </script>
</polymer-element>
