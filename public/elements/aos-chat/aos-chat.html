<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../aos-globals/aos-globals.html">
<link rel="import" href="elements/chat-useritem/chat-useritem.html">
<link rel="import" href="elements/chat-module/chat-module.html">

<polymer-element name="aos-chat" attributes="user">
  <template>
    <link rel="stylesheet" href="aos-chat.css">
    <aos-globals id="globals" on-values-changed="{{test}}" values="{{globs}}"></aos-globals>

    <core-ajax id="finduser" on-core-response="{{userresp}}" response="{{userresponse}}"></core-ajax>

    <template if="{{$.globals.values.user}}">


      <div id="chatcontainer" class="container {{ {open: chatopened} | tokenList}}" vertical layout start start-justified>
<!-- <core-animated-pages id="scenes" transitions="slide-from-right">
<section>
 -->
        <div>

        <template if="{{!chatactive}}">
          <div id="chatstatus"  on-tap="{{toggle}}">
            <p>Chat (inactief) {{user}}</p>
          </div>

          <div class="chatlist" hidden?="{{!chatopened}}">
            <p>Vanaf nu kan je ook chatten! Wil je de chatfunctie activeren?</p>
            <button on-tap="{{activateChat}}">Activeer chat</button>
          </div>
        </template>
          
        <template if="{{chatactive}}">
        
          <div class="chatlistitem" horizontal layout center start-justified id="chatstatus" on-tap="{{toggle}}">
            <img class="chatavatar" src="{{$.globals.values.user.data.avatarUrl}}">
            <p>Online</p>

          </div>

          <div class="chatlist" hidden?="{{!chatopened}}">

          <firebase-element id="conversations" location="https://blazing-fire-6426.firebaseio.com/chat/directory/{{$.globals.values.user.data.id}}/chats/" data="{{data}}" keys="{{keys}}" on-data-change="{{convchange}}" log></firebase-element>


          <!-- deze core selector moet nog in nieuwe component zodat ik meer data kan meegeven als select event fired -->

          <core-selector id="convselector" valueattr="conversation" selected="{{selectedConversation}}">

            <template repeat="{{k, i in keys}}">
              <div class="chatlistitem" horizontal layout center start-justified conversation="{{k}}">
              <img class="chatavatar" src="{{data[k].avatar}}">
              <p>{{data[k].with}}</p>
              <small>{{data[k].lastpost}}</small>
              </div>
            </template>

          </core-selector>
            <input type="text" id="gebruikercheck" value="{{uservalue}}" placeholder="Gebruikersnaam" />
                                        <button on-tap="{{toScene2}}">hier</button>

            <template repeat="{{s, i in users}}">
                <div class="item" key="{{users[i].id}}">
                  <chat-useritem user="{{users[i]}}"></chat-useritem>
                </div>

            </template>


            

            
          </div>



        </template>
        </div>

<!-- </section>
<section> -->

     <!--    Dit is de module die in section 2 van animated pages moet komen -->
      <div id="module" class="module" vertical layout start start-justified>
      <chat-module conversation="{{selectedConversation}}"></chat-module>
      </div>
 </section>
</core-animated-pages>
              </div>

              <div id="module" class="module" vertical layout start start-justified>
      <chat-module conversation="{{selectedConversation}}"></chat-module>
      </div>


    </template>
    <template if="{{!$.globals.values.user}}">
     
    </template>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        // define element prototype here

      ready: function() {
        this.chatactive = false;


        var that = this;

        document.addEventListener('user-changed', function(e){
          var userid = that.$.globals.values.user.data.id;
          that.checkUserChatActive(userid);
        });

        document.addEventListener('keyup', function(e) {
          var ajax = that.$.finduser;
          // keycode 13 = ENTER toets
          if (e.keyCode == 13) {};
          that.$.finduser.url = "/gebruiker/?search="+that.uservalue;
          ajax.go();
        });

        document.addEventListener('buddy-select',function(e){
          //console.log('buddy selected', e.detail.buddy);
          that.selectedUser = e.detail.buddy;
          //start conversation
          var userid = that.$.globals.values.user.data.id;
          var guest = e.detail.buddy;
          var username = that.$.globals.values.user.data.username;
          var guestname = e.detail.username;
          var useravatar = that.$.globals.values.user.data.avatarUrl;
          var guestavatar = e.detail.avatar;
          var FBstartconv = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/conversations/");
          var newpostRef = FBstartconv.push({  "initiator": userid,
                            "guest": guest,
                            "initiatorname": username,
                            "guestname": guestname,
                            "initiatoravatar": useravatar,
                            "guestavatar": guestavatar,
                            "starttime":Firebase.ServerValue.TIMESTAMP,
                            "lastpost": Firebase.ServerValue.TIMESTAMP,
                            "participants": [guest, userid] });
          var newKey = newpostRef.key();
          console.log(newKey, ' - ', guest);

          var FBaddpart2 = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/directory/"+guest+"/chats/"+newKey+"/");
           var userkey2 = FBaddpart2.set({ 
                          "conversation": newKey, 
                          "lastpost": Firebase.ServerValue.TIMESTAMP,
                          "with": username,
                          "avatar": useravatar
                           });


          var FBaddpart1 = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/directory/"+userid+"/chats/"+newKey+"/");
           var userkey = FBaddpart1.set({ 
                          "conversation": newKey, 
                          "lastpost": Firebase.ServerValue.TIMESTAMP,
                          "with": guestname,
                          "avatar": guestavatar });

          that.selectedConversation = newKey;
          
        });

               
        
      },

      convchange: function(){
        console.log(this.data);
      },

      userresp: function(){
        this.users = JSON.parse(this.userresponse);
        //this.users = this.users.data;
      },

      checkUserChatActive: function(){
        var that = this;
        var userid = this.$.globals.values.user.data.id;
        var FBcheck = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/directory/"+userid+"/");
          FBcheck.once('value', function(dataSnapshot) {
            that.chatactive = dataSnapshot.val();
          });
      },

      toggle: function() {
        this.checkUserChatActive();
        this.chatopened = !this.chatopened;
      },

      toScene2:function () {
        this.$.scenes.selected = 1;
      },


      

      //FB voor chatmsg: chat/user/kingflurkelID/chats/benadID/$KEY/message-timestamp-avatar




      activateChat: function(){
        var userid = this.$.globals.values.user.data.id;
        var user = this.$.globals.values.user.data.username;
        var firstname = this.$.globals.values.user.data.firstName;
        var lastname = this.$.globals.values.user.data.lastName;
        var email = this.$.globals.values.user.data.email;
        var avatar = this.$.globals.values.user.data.avatarUrl;

        var FBsaveuser = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/directory/"+userid+"/");
        var DirectoryResult = FBsaveuser.set({
          "userid":userid, 
          "username": user, 
          "firstname":firstname, 
          "lastname": lastname, 
          "email": email,
          "avatar": avatar,
          "time":Firebase.ServerValue.TIMESTAMP
        });

        //var newKey = newpostRefa.key();
        //console.log('New chatmessage saved at: '+newKey);
        this.checkUserChatActive(userid);
      }

      });

    })();
  </script>
</polymer-element>
