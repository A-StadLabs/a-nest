<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<link rel="import" href="../aos-globals/aos-globals.html">
<link rel="import" href="elements/chat-useritem/chat-useritem.html">

<polymer-element name="aos-chat" attributes="user">
  <template>
    <link rel="stylesheet" href="aos-chat.css">
    <aos-globals id="globals" on-values-changed="{{test}}" values="{{globs}}"></aos-globals>

    <core-ajax id="finduser" on-core-response="{{userresp}}" response="{{userresponse}}"></core-ajax>

    <template if="{{$.globals.values.user}}">



      <div id="chatcontainer" class="container {{ {open: chatopened} | tokenList}}" vertical layout start start-justified>

        <div>

        <template if="{{!chatactive}}">

          <div id="chatstatus"  on-tap="{{toggle}}">
            <p>Chat (inactief) {{user}}</p>
          </div>

          <div class="chatlist" hidden?="{{!chatopened}}">
            <p>Vanaf nu kan je ook chatten! Wil je de chatfunctie activeren?</p>
            <button on-tap="{{activateChat}}">Activeer chat</button>
          </div>

        </template>
          
        <template if="{{chatactive}}">
        
          <div class="chatlistitem" horizontal layout center start-justified id="chatstatus" on-tap="{{toggle}}">
            <img class="chatavatar" src="{{$.globals.values.user.data.avatarUrl}}">
            <p>Online</p>
          </div>

          <div class="chatlist" hidden?="{{!chatopened}}">
            <input type="text" id="gebruikercheck" value="{{uservalue}}" placeholder="Gebruikersnaam" />
            <template repeat="{{s, i in users}}">
              <core-selector valueattr="key" selected="{{uservalue}}">
                <div class="item" key="{{users[i].id}}">
                  <chat-useritem user="{{users[i]}}"></chat-useritem>
                </div>
              </core-selector>
            </template>
          </div>

          

          <!-- <div id="chatlist" hidden?="{{!chatopened}}">
            <div class="chatlistitem" horizontal layout center start-justified>
              <img class="chatavatar" src="{{$.globals.values.user.data.avatarUrl}}">
              <p>Username</p>
            </div>
            <div class="chatlistitem" horizontal layout center start-justified>
              <img class="chatavatar" src="{{$.globals.values.user.data.avatarUrl}}">
              <p>Username</p>
            </div>
            <div class="chatlistitem" horizontal layout center start-justified>
              <img class="chatavatar" src="{{$.globals.values.user.data.avatarUrl}}">
              <p>Username</p>
            </div>
            <div class="chatlistitem" horizontal layout center start-justified>
              <img class="chatavatar" src="{{$.globals.values.user.data.avatarUrl}}">
              <p>Username</p>
            </div>
          </div> -->

        </template>

        </div>
      </div>








  <!--     


HIER WAS IK BEZIG AAN DIE AFZONDERLIJKE CHATS. JUIST ZO?




  <div id="" class="container {{ {open: chatopened} | tokenList}}" vertical layout start start-justified>

        <div>
        <template>

          <div id="chatstatus"  on-tap="{{toggleItem}}">
            <p>Chat (inactief) {{user}}</p>
          </div>

          <div class="chatlist" hidden?="{{!chatopened}}">
            <p>Vanaf nu kan je ook chatten! Wil je de chatfunctie activeren?</p>
            <button on-tap="{{activateChat}}">Activeer chat</button>
          </div>

        </template>
          
        <template if="{{chatactive}}">
        
          <div id="chatstatus"  on-tap="{{toggleItem}}">
            <p>naam</p>
          </div>

          <div class="chatlist" hidden?="{{!chatitemopened}}">
            <input type="text" id="chatwindow" value="" placeholder="Hmmmmkay?" />
          </div>

        </template>

        </div>
      </div>

 -->



    </template>
    <template if="{{!$.globals.values.user}}">
     
    </template>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        // define element prototype here

      ready: function() {
        this.chatactive = false;

        var that = this;

        document.addEventListener('user-changed', function(e){
          var userid = that.$.globals.values.user.data.id;
          that.checkUserChatActive(userid);
        });

        document.addEventListener('keyup', function(e) {
          var ajax = that.$.finduser;
          // keycode 13 = ENTER toets
          if (e.keyCode == 13) {};
          that.$.finduser.url = "/gebruiker/?search="+that.uservalue;
          ajax.go();
        });
        
      },

      userresp: function(){
        this.users = JSON.parse(this.userresponse);
        //this.users = this.users.data;
      },

      checkUserChatActive: function(){
        var that = this;
        var userid = this.$.globals.values.user.data.id;
        var FBcheck = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/directory/"+userid+"/");
          FBcheck.once('value', function(dataSnapshot) {
            that.chatactive = dataSnapshot.val();
          });
      },

      toggle: function() {
        this.checkUserChatActive();
        this.chatopened = !this.chatopened;
      },


      //FB voor chatmsg: chat/user/kingflurkelID/chats/benadID/$KEY/message-timestamp-avatar




      activateChat: function(){
        var userid = this.$.globals.values.user.data.id;
        var user = this.$.globals.values.user.data.username;
        var firstname = this.$.globals.values.user.data.firstName;
        var lastname = this.$.globals.values.user.data.lastName;
        var email = this.$.globals.values.user.data.email;
        var avatar = this.$.globals.values.user.data.avatarUrl;

        var FBsaveuser = new Firebase("https://blazing-fire-6426.firebaseio.com/chat/directory/"+userid+"/");
        var DirectoryResult = FBsaveuser.set({
          "userid":userid, 
          "username": user, 
          "firstname":firstname, 
          "lastname": lastname, 
          "email": email,
          "avatar": avatar,
          "time":Firebase.ServerValue.TIMESTAMP
        });

        //var newKey = newpostRefa.key();
        //console.log('New chatmessage saved at: '+newKey);
        this.checkUserChatActive(userid);
      }

      });

    })();
  </script>
</polymer-element>
